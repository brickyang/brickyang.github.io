<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>从 GitHub 到 GitLab，打造私有项目 CI/CD 工作流 | 全栈渐进之路</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">从 GitHub 到 GitLab，打造私有项目 CI/CD 工作流</h1><a id="logo" href="/.">全栈渐进之路</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">从 GitHub 到 GitLab，打造私有项目 CI/CD 工作流</h1><div class="post-meta">Jan 4, 2018<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="post-content"><p>一直用 GitHub 托管所有代码，包括一些非开源的商业项目，同时也一直在寻找最佳的 CI/CD 工作流配置。作为个人开发者，主要的需求有两个：</p>
<ol>
<li>不自建服务；</li>
<li>成本越低越好，最好免费。</li>
</ol>
<h2 id="GitHub-的不足"><a href="#GitHub-的不足" class="headerlink" title="GitHub 的不足"></a>GitHub 的不足</h2><p>GitHub 首先对私有仓库收费，新政策 7 美元/月还算便宜，比以前按仓库数量收费好得多。最主要的问题还是没有很合适的 CI/CD 服务。Travis CI 只对公开项目免费，对私有项目收费且价格不菲；CircleCI 对私有项目免费，但配置比较难用，也不是很满意。</p>
<h2 id="GitLab-的优势"><a href="#GitLab-的优势" class="headerlink" title="GitLab 的优势"></a>GitLab 的优势</h2><p>在试用了 GitLab 后发现以上问题都可以解决：</p>
<ol>
<li>无限制私有仓库</li>
<li>内置 CI/CD 服务，且配置简单易用，支持 Docker</li>
<li>内置私有的 Docker 仓库</li>
<li>免费</li>
</ol>
<p>我已经重新梳理了项目的开发-测试-部署流程，并把所有个人非开源项目都转移到 GitLab，把 GitHub 账户重新降级为 Free。</p>
<h2 id="工作流"><a href="#工作流" class="headerlink" title="工作流"></a>工作流</h2><p>我目前采用的工作流依托两个工具：</p>
<ol>
<li>Git：版本控制和管理</li>
<li>Docker：部署和运行应用</li>
</ol>
<p>我自己目前主要是个人开发，多人开发流程需要做一些调整。</p>
<ol>
<li>在本地 <code>dev</code> 分支上开发和单元测试</li>
<li>测试通过后，<code>merge</code> 到本地 <code>master</code> 分支</li>
<li>对 <code>master</code> 分支打 <code>tag</code>，<code>push</code> 到 GitLab</li>
<li>GitLab 自动进行构建和测试</li>
<li>测试通过后自动 <code>build image</code>，并将其 <code>push</code> 到 GitLab 提供的免费 Docker 仓库</li>
<li>手动登录服务器，<code>pull image</code>，替换 <code>container</code></li>
</ol>
<p>其中 4、5 两步在 GitLab 上自动完成，并且只对 tag 的推送进行操作。</p>
<h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><p>这是一个 TypeScript 的 Node.js 项目的实例。</p>
<h3 id="gitlab-ci-yml"><a href="#gitlab-ci-yml" class="headerlink" title=".gitlab-ci.yml"></a>.gitlab-ci.yml</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">build:</span></span><br><span class="line"><span class="attr">  only:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">tags</span></span><br><span class="line"><span class="attr">  stage:</span> <span class="string">build</span></span><br><span class="line"><span class="attr">  image:</span> <span class="attr">node:8</span></span><br><span class="line"><span class="attr">  script:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">npm</span> <span class="string">install</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">tsc</span></span><br><span class="line"><span class="attr">  artifacts:</span></span><br><span class="line"><span class="attr">    paths:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">node_modules/</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">app/**/*.js</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">app/*.js</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">config/*.js</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">app.js</span></span><br><span class="line"><span class="attr">    expire_in:</span> <span class="number">1</span> <span class="string">day</span></span><br><span class="line"></span><br><span class="line"><span class="attr">test:</span></span><br><span class="line"><span class="attr">  only:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">tags</span></span><br><span class="line"><span class="attr">  stage:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">  image:</span> <span class="attr">node:8</span></span><br><span class="line"><span class="attr">  services:</span></span><br><span class="line"><span class="attr">    - redis:</span><span class="number">3.2</span></span><br><span class="line"><span class="attr">  script:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">test-ci</span></span><br><span class="line"></span><br><span class="line"><span class="attr">docker:</span><span class="attr">image:</span></span><br><span class="line"><span class="attr">  only:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">tags</span></span><br><span class="line"><span class="attr">  stage:</span> <span class="string">deploy</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">docker</span></span><br><span class="line"><span class="attr">  services:</span></span><br><span class="line"><span class="attr">    - docker:</span><span class="string">dind</span></span><br><span class="line"><span class="attr">  script:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">docker</span> <span class="string">version</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">docker</span> <span class="string">build</span> <span class="bullet">-t</span> <span class="string">$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME</span> <span class="string">.</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">echo</span> <span class="string">$GITLAB_USER_LOGIN</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">echo</span> <span class="string">$CI_JOB_TOKEN</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">echo</span> <span class="string">$CI_REGISTRY</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">docker</span> <span class="string">login</span> <span class="bullet">-u</span> <span class="string">gitlab-ci-token</span> <span class="bullet">-p</span> <span class="string">$CI_JOB_TOKEN</span> <span class="string">$CI_REGISTRY</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">docker</span> <span class="string">push</span> <span class="string">$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME</span></span><br></pre></td></tr></table></figure>
<p>GitLab 的 CI 过程分为多个 <code>job</code>，每个 <code>job</code> 彼此独立，可以实现复杂的 CI 过程，比如多环境并行测试。像这样一个简单的项目其实不需要分 <code>job</code>，因为每个 <code>job</code> 都要新建环境，浪费时间。</p>
<p>GitLab 的文档非常简单易懂，这里只说几个值得注意的点：</p>
<ol>
<li>在 <code>build</code> 中产生的文件（安装的依赖和编译文件），需要通过 <code>artifacts</code> 传递给后续的 <code>jobs</code>，否则后续 <code>jobs</code> 的环境中是没有这些文件的。</li>
<li>所有环境和数据库都在不同的 Docker <code>container</code> 中，所以连接数据库不能用 <code>Host: localhost</code>，而要用 <code>Host: redis</code>、<code>Host: mysql</code> 这种。</li>
<li><code>$CI_REGISTRY</code> 这种是 GitLab 的<a href="https://docs.gitlab.com/ce/ci/variables/README.html" title="GitLab CI/CD Variables" target="_blank" rel="noopener">预设变量</a>，可以直接使用。<code>$CI_JOB_TOKEN</code> 需要在设置页面先新建一个 Access Token。</li>
</ol>
<p>GitLab 提供了 <a href="https://gitlab.com/ci/lint" target="_blank" rel="noopener">CI Lint</a> 工具检查 <code>.gitlab-ci.yml</code> 文件的语法正确性。</p>
<h3 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h3><p>CI 的最后一步是 <code>build</code> Docker Image，所以要提供 Dockerfile 文件。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">FROM</span> <span class="attr">node:8.0</span></span><br><span class="line"></span><br><span class="line"><span class="string">RUN</span> <span class="string">echo</span> <span class="string">"Asia/Shanghai"</span> <span class="string">&gt; /etc/timezone</span></span><br><span class="line"><span class="string">RUN dpkg-reconfigure -f noninteractive tzdata</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">RUN mkdir -p /app</span></span><br><span class="line"><span class="string">WORKDIR /app</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ADD node_modules /app/node_modules</span></span><br><span class="line"><span class="string">ADD app/*.js /app/app/</span></span><br><span class="line"><span class="string">ADD config/*.js /app/config/</span></span><br><span class="line"><span class="string">ADD app.js /app/app.js</span></span><br><span class="line"><span class="string">ADD package.json /app/package.json</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">RUN cd /app</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ENV NODE_ENV=production</span></span><br><span class="line"><span class="string">ENV PORT=3000</span></span><br><span class="line"><span class="string">EXPOSE 3000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">CMD ["npm", "start"]</span></span><br></pre></td></tr></table></figure>
<p>值得注意下的是 <a href="https://docs.docker.com/engine/reference/builder/#add" title="Dockerfile reference#ADD" target="_blank" rel="noopener"><code>ADD</code> 命令</a>，如果：</p>
<ol>
<li><code>ADD</code> 文件夹到目标位置，目标路径结尾没有 <code>/</code>：<code>ADD node_modules /app/node_modules</code></li>
<li><code>ADD</code> 多个文件到目标位置，目标路径结尾有 <code>/</code>：<code>ADD app/*.js /app/app/</code></li>
</ol>
<h2 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h2><p>目前发现这个过程唯一的缺点是，阿里云从 GitLab <code>pull image</code> 的网络连接很差，经常容易失败，比较考验 RP。这是阿里云的老问题了，对 GitHub 和 npm 的连接都很差。</p>
<p>如果对这一点不能忍受，可以选择其他 Docker 仓库，只需修改 <code>.gitlab-ci.yml</code> 的最后一句即可。</p>
<hr>
<ul>
<li><a href="https://docs.gitlab.com/ce/ci/yaml/README.html" target="_blank" rel="noopener">Configuration of your jobs with .gitlab-ci.yml</a></li>
<li><a href="https://docs.docker.com/engine/reference/builder/" target="_blank" rel="noopener">Dockerfile reference</a></li>
</ul>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://brickyang.github.io/2018/01/04/从-GitHub-到-GitLab，打造私有项目-CI-CD-工作流/" data-id="cjqkrdmxi000ctcru1nu3ojss" class="article-share-link">分享到</a><div class="tags"><a href="/tags/Docker/">Docker</a><a href="/tags/GitLab/">GitLab</a></div><div class="post-nav"><a href="/2018/03/10/Node-js-解决-csv-文件乱码的两种办法/" class="pre">Node.js 解决 csv 文件乱码的两种办法</a><a href="/2017/12/21/如何在-Egg-js-中使用-TypeScript/" class="next">如何在 Egg.js 中使用 TypeScript</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Tensorflow/" style="font-size: 15px;">Tensorflow</a> <a href="/tags/Node-js/" style="font-size: 15px;">Node.js</a> <a href="/tags/Shadowsocks/" style="font-size: 15px;">Shadowsocks</a> <a href="/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/MongoDB/" style="font-size: 15px;">MongoDB</a> <a href="/tags/Egg-js/" style="font-size: 15px;">Egg.js</a> <a href="/tags/Lisp-Scheme/" style="font-size: 15px;">Lisp/Scheme</a> <a href="/tags/Program/" style="font-size: 15px;">Program</a> <a href="/tags/GitLab/" style="font-size: 15px;">GitLab</a> <a href="/tags/DeepLearning/" style="font-size: 15px;">DeepLearning</a> <a href="/tags/CentOS/" style="font-size: 15px;">CentOS</a> <a href="/tags/Keras/" style="font-size: 15px;">Keras</a> <a href="/tags/SSH/" style="font-size: 15px;">SSH</a> <a href="/tags/WeChat/" style="font-size: 15px;">WeChat</a> <a href="/tags/前端/" style="font-size: 15px;">前端</a> <a href="/tags/Canvas/" style="font-size: 15px;">Canvas</a> <a href="/tags/TypeScript/" style="font-size: 15px;">TypeScript</a> <a href="/tags/React/" style="font-size: 15px;">React</a> <a href="/tags/Ant-Design/" style="font-size: 15px;">Ant Design</a> <a href="/tags/Webpack/" style="font-size: 15px;">Webpack</a> <a href="/tags/Babel/" style="font-size: 15px;">Babel</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/01/06/Node-js-利用异步提升任务处理速度/">Node.js 利用异步提升任务处理速度</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/27/纯前端-Canvas-实现-HTML-转图片，自动生成微信阅读卡片/">纯前端 Canvas 实现 HTML 转图片，自动生成微信阅读卡片</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/16/利用-SSH-端口转发进行微信开发本地调试/">利用 SSH 端口转发进行微信开发本地调试</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/11/《计算机程序的构造和解释》（SICP）练习题解集/">《计算机程序的构造和解释》（SICP）练习题解集</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/10/Node-js-解决-csv-文件乱码的两种办法/">Node.js 解决 csv 文件乱码的两种办法</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/04/从-GitHub-到-GitLab，打造私有项目-CI-CD-工作流/">从 GitHub 到 GitLab，打造私有项目 CI/CD 工作流</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/21/如何在-Egg-js-中使用-TypeScript/">如何在 Egg.js 中使用 TypeScript</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/18/利用-AWS-搭建-Tensoflow-Keras-深度学习环境/">利用 AWS 搭建 Tensoflow + Keras 深度学习环境</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/04/egg-mongo-native，基于-MongoDB-Native-Driver/">egg-mongo-native，基于 MongoDB Native Driver</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/12/在-CentOS-7-上安装-Docker-CE/">在 CentOS 7 上安装 Docker</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">全栈渐进之路.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>